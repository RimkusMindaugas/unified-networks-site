---
import { ANALYTICS } from 'astrowind:config';

const gaId = ANALYTICS?.vendors?.googleAnalytics?.id ? String(ANALYTICS.vendors.googleAnalytics.id) : '';
---

{
  gaId ? (
    <script is:inline define:vars={{ gaId }}>
      (() => {
        if (window.__unAnalyticsScriptInitialized) return;
        window.__unAnalyticsScriptInitialized = true;

        const CONSENT_KEY = 'un_cookie_consent';
        const CONSENT_COOKIE = 'un_cookie_consent';
        const WHATSAPP_DIRECT_LINK_REGEX = /^https?:\/\/wa\.me\/\d+/i;
        const RECENT_EVENT_WINDOW_MS = 800;
        const recentlyTrackedEvents = new Map();

        const getConsent = () => {
          try {
            const stored = localStorage.getItem(CONSENT_KEY);
            if (stored) return stored;
          } catch (_) {
            // Ignore localStorage access errors
          }

          const match = document.cookie.match(new RegExp(`(?:^|; )${CONSENT_COOKIE}=([^;]*)`));
          return match ? decodeURIComponent(match[1]) : null;
        };

        const loadGoogleAnalytics = () => {
          if (window.__unGoogleAnalyticsLoaded) return;
          window.__unGoogleAnalyticsLoaded = true;

          window.dataLayer = window.dataLayer || [];
          window.gtag =
            window.gtag ||
            function () {
              window.dataLayer.push(arguments);
            };

          window.gtag('js', new Date());
          window.gtag('config', gaId, {
            anonymize_ip: true,
            send_page_view: true,
          });

          const script = document.createElement('script');
          script.async = true;
          script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(gaId)}`;
          document.head.appendChild(script);
        };

        const trackEvent = (eventName, params = {}) => {
          if (typeof window.gtag !== 'function') return;
          window.gtag('event', eventName, {
            transport_type: 'beacon',
            ...params,
          });
        };

        const isDuplicateEvent = (eventName, linkUrl) => {
          const key = `${eventName}:${linkUrl}`;
          const now = Date.now();
          const lastTrackedAt = recentlyTrackedEvents.get(key) || 0;
          recentlyTrackedEvents.set(key, now);
          return now - lastTrackedAt < RECENT_EVENT_WINDOW_MS;
        };

        const trackPageView = () => {
          trackEvent('page_view', {
            page_title: document.title,
            page_location: window.location.href,
            page_path: `${window.location.pathname}${window.location.search}`,
          });
        };

        const trackContactLinkClicks = () => {
          const trackFromEvent = (event, sourceType) => {
            const target = event.target;
            if (!(target instanceof Element)) return;

            const anchor = target.closest('a[href]');
            if (!(anchor instanceof HTMLAnchorElement)) return;

            const href = anchor.href || '';
            if (!href) return;

            if (href.startsWith('tel:')) {
              if (isDuplicateEvent('phone_click', href)) return;
              trackEvent('phone_click', {
                link_url: href,
                page_location: window.location.href,
                link_text: (anchor.textContent || '').trim(),
                interaction_type: sourceType,
              });
              return;
            }

            if (sourceType === 'click' && WHATSAPP_DIRECT_LINK_REGEX.test(href)) {
              if (isDuplicateEvent('whatsapp_click', href)) return;
              trackEvent('whatsapp_click', {
                link_url: href,
                page_location: window.location.href,
                link_text: (anchor.textContent || '').trim(),
                interaction_type: sourceType,
              });
            }
          };

          document.addEventListener(
            'pointerdown',
            (event) => {
              trackFromEvent(event, 'pointerdown');
            },
            { capture: true }
          );

          document.addEventListener(
            'click',
            (event) => {
              trackFromEvent(event, 'click');
            },
            { capture: true }
          );
        };

        const trackLeadFormSubmissions = () => {
          document.addEventListener(
            'submit',
            (event) => {
              const form = event.target;
              if (!(form instanceof HTMLFormElement)) return;
              if (!form.hasAttribute('data-netlify')) return;

              const submittedFormName = form.getAttribute('name') || form.getAttribute('data-form-name') || 'contact';
              trackEvent('form_submit', {
                form_name: submittedFormName,
                page_location: window.location.href,
                page_path: `${window.location.pathname}${window.location.search}`,
              });
            },
            { capture: true }
          );
        };

        if (getConsent() === 'accepted') {
          loadGoogleAnalytics();
        }

        trackContactLinkClicks();
        trackLeadFormSubmissions();

        window.addEventListener('un:cookie-consent-accepted', loadGoogleAnalytics);
        document.addEventListener('astro:after-swap', trackPageView);
      })();
    </script>
  ) : null
}
