---
import { ANALYTICS } from 'astrowind:config';

const gaId = ANALYTICS?.vendors?.googleAnalytics?.id ? String(ANALYTICS.vendors.googleAnalytics.id) : '';
---

{
  gaId ? (
    <script is:inline define:vars={{ gaId }}>
      (() => {
        if (window.__unAnalyticsScriptInitialized) return;
        window.__unAnalyticsScriptInitialized = true;

        const CONSENT_KEY = 'un_cookie_consent';
        const CONSENT_COOKIE = 'un_cookie_consent';

        const getConsent = () => {
          try {
            const stored = localStorage.getItem(CONSENT_KEY);
            if (stored) return stored;
          } catch (_) {
            // Ignore localStorage access errors
          }

          const match = document.cookie.match(new RegExp(`(?:^|; )${CONSENT_COOKIE}=([^;]*)`));
          return match ? decodeURIComponent(match[1]) : null;
        };

        const loadGoogleAnalytics = () => {
          if (window.__unGoogleAnalyticsLoaded) return;
          window.__unGoogleAnalyticsLoaded = true;

          window.dataLayer = window.dataLayer || [];
          window.gtag =
            window.gtag ||
            function () {
              window.dataLayer.push(arguments);
            };

          window.gtag('js', new Date());
          window.gtag('config', gaId, {
            anonymize_ip: true,
            send_page_view: true,
          });

          const script = document.createElement('script');
          script.async = true;
          script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(gaId)}`;
          document.head.appendChild(script);
        };

        const trackPageView = () => {
          if (typeof window.gtag !== 'function') return;

          window.gtag('event', 'page_view', {
            page_title: document.title,
            page_location: window.location.href,
            page_path: `${window.location.pathname}${window.location.search}`,
          });
        };

        if (getConsent() === 'accepted') {
          loadGoogleAnalytics();
        }

        window.addEventListener('un:cookie-consent-accepted', loadGoogleAnalytics);
        document.addEventListener('astro:after-swap', trackPageView);
      })();
    </script>
  ) : null
}
