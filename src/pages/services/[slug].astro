---
import Layout from '~/layouts/PageLayout.astro';

import Hero from '~/components/widgets/Hero.astro';
import Features from '~/components/widgets/Features.astro';
import FAQs from '~/components/widgets/FAQs.astro';
import Note from '~/components/widgets/Note.astro';
import type { ServicePageData } from '~/data/services';
import { coverageSummary, getRelatedPostSlugsForService, services } from '~/data/services';
import { findPostsBySlugs } from '~/utils/blog';
import { getBlogPermalink, getPermalink } from '~/utils/permalinks';

export const getStaticPaths = () =>
  services.map((service) => ({
    params: { slug: service.slug },
    props: { service },
  }));

const { service } = Astro.props as { service: ServicePageData };

const defaultContactNumber = '353874118332';
const contactNumber = (
  import.meta.env.PUBLIC_CONTACT_PHONE ||
  import.meta.env.PUBLIC_WHATSAPP_NUMBER ||
  defaultContactNumber
).replace(/\D/g, '');
const whatsappNumber = (import.meta.env.PUBLIC_WHATSAPP_NUMBER || contactNumber).replace(/\D/g, '');
const whatsappMessage = encodeURIComponent(`Hi Unified Networks, I need help with ${service.title}.`);
const phoneHref = `tel:+${contactNumber}`;
const whatsappHref = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;

const metadata = {
  title: service.metadataTitle,
  ignoreTitleTemplate: true,
  description: service.metadataDescription,
};
const serviceUrl = `https://unifiednetworks.ie/services/${service.slug}`;
const relatedPostSlugs = getRelatedPostSlugsForService(service.slug);
const relatedPosts = await findPostsBySlugs(relatedPostSlugs);

const serviceSchema = {
  '@context': 'https://schema.org',
  '@type': 'Service',
  name: service.title,
  description: service.metadataDescription,
  serviceType: service.title,
  areaServed: coverageSummary,
  provider: {
    '@type': 'LocalBusiness',
    name: 'Unified Networks',
    url: 'https://unifiednetworks.ie',
    telephone: `+${contactNumber}`,
  },
  url: serviceUrl,
};

const faqPageSchema = {
  '@context': 'https://schema.org',
  '@type': 'FAQPage',
  mainEntity: service.faqs.map((faq) => ({
    '@type': 'Question',
    name: faq.title,
    acceptedAnswer: {
      '@type': 'Answer',
      text: faq.description,
    },
  })),
};

const breadcrumbSchema = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: 'https://unifiednetworks.ie/',
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Services',
      item: 'https://unifiednetworks.ie/services',
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: service.title,
      item: serviceUrl,
    },
  ],
};

const consultationText = `Need this service in Dublin or surrounding areas? Call <a class="underline" href="${phoneHref}">+${contactNumber}</a>, <a class="underline" href="${whatsappHref}" target="_blank" rel="noopener noreferrer">chat on WhatsApp</a>, or <a class="underline" href="/#contact">book a consultation</a>. You can also check <a class="underline" href="/areas-we-serve">areas we serve</a>.`;
---

<Layout metadata={metadata}>
  <script is:inline type="application/ld+json" set:html={JSON.stringify(serviceSchema)} />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(faqPageSchema)} />
  <script is:inline type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

  <Hero
    image={{
      src: '~/assets/images/hero-image.png',
      alt: `${service.title} in Dublin and surrounding areas`,
    }}
    actions={[
      {
        variant: 'primary',
        text: 'Book Free Consultation',
        href: '/#contact',
        icon: 'tabler:mail',
      },
      {
        text: 'Call Now',
        href: phoneHref,
        icon: 'tabler:phone-call',
      },
      {
        text: 'Chat on WhatsApp',
        href: whatsappHref,
        target: '_blank',
        icon: 'tabler:brand-whatsapp',
      },
    ]}
  >
    <Fragment slot="title">{service.heroTitle}</Fragment>
    <Fragment slot="subtitle">{service.heroSubtitle}</Fragment>
  </Hero>

  <section class="max-w-5xl mx-auto px-4 sm:px-6 py-10 sm:py-14">
    <div class="grid gap-10 md:grid-cols-2">
      <div>
        <h2 class="text-2xl md:text-3xl font-bold">{service.introTitle}</h2>
        <p class="mt-4 text-lg text-muted">{service.introBody}</p>
      </div>

      <div>
        <h2 class="text-2xl md:text-3xl font-bold">What You Should Expect</h2>
        <ul class="mt-4 space-y-3 text-muted">
          {
            service.outcomes.map((outcome) => (
              <li class="flex items-start gap-3">
                <span class="mt-1 inline-block h-2 w-2 rounded-full bg-primary" />
                <span>{outcome}</span>
              </li>
            ))
          }
        </ul>
      </div>
    </div>
  </section>

  <Features
    id="service-details"
    tagline="What Is Included"
    title={service.title}
    subtitle={`Service delivery focused on reliable outcomes across ${coverageSummary}.`}
    items={service.features}
  />

  <FAQs
    id="service-faq"
    tagline="Service FAQ"
    title={`Questions About ${service.title}`}
    subtitle="Straight answers before you commit."
    classes={{ container: 'max-w-5xl' }}
    items={service.faqs}
  />

  {
    relatedPosts.length > 0 && (
      <section class="max-w-5xl mx-auto px-4 sm:px-6 py-8 sm:py-10">
        <h2 class="text-2xl md:text-3xl font-bold tracking-tight font-heading mb-3">Related Guides</h2>
        <p class="text-muted dark:text-slate-400 mb-4">
          Read these practical guides before choosing equipment or booking installation:
        </p>
        <ul class="list-disc pl-5 space-y-2 marker:text-primary dark:marker:text-blue-400">
          {relatedPosts.map((post) => (
            <li>
              <a href={getPermalink(post.permalink, 'post')} class="text-primary dark:text-blue-400 hover:underline font-medium">
                {post.title}
              </a>
            </li>
          ))}
        </ul>
        <a
          class="inline-block mt-5 text-muted dark:text-slate-400 hover:text-primary dark:hover:text-blue-400 transition ease-in duration-200"
          href={getBlogPermalink()}
        >
          View all guides >
        </a>
      </section>
    )
  }

  <Note icon="tabler:message-circle" title="Talk To Us Directly." description={consultationText} />
</Layout>
